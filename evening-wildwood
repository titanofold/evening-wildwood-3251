#!/usr/bin/env perl
use Mojolicious::Lite;
use DBIx::Connector;

my $conn
  = DBIx::Connector->new("dbi:Pg:$ENV{DATABASE_URL}", '', '',
  {AutoCommit => 0})
  or die;
$conn->mode('fixup');

# Documentation browser under "/perldoc"
# plugin 'PODRenderer';

helper get_header_value =>
  sub { return shift->req->headers->{headers}->{$_[0]}->[-1] };

sub add_pilot {
  my $pilot = shift;
  my $role  = shift;
  return 0 unless $role =~ /^orca|rorqual|miner|hauler$/i;
  return 1;
}

sub add_harvest {

}

sub add_expense { }

sub add_income { }

get '/' => sub {
  my $self = shift;
  $self->render('index');
};

get '/test' => sub {
  my $self = shift;
  $self->stash(headers => $self->req->headers);
  $self->render;
};

get '/op' => sub {
  my $self = shift;
  $self->render('op');
};

under '/op/:op' => [op => qr/\d+/] => sub {
  my $self = shift;
  my $op   = $self->param('op');

#$conn->run(sub{$_->selectrow_array('SELECT COUNT(id) FROM ew.ops WHERE id = ?;')});
};

get '/' => sub {
  my $self = shift;
  my $op   = $self->param('op');
  $self->render('op');
};

get '/join' => sub {
  my $self = shift;
  $self->redirect_to('/');
};

get '/finish' => sub {
  my $self = shift;
  $self->redirect_to('/');
};

post '/update' => sub {
  my $self = shift;
  $self->render('update');
};

app->start;
